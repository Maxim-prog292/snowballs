<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <title>Снежки</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      #game {
        touch-action: none;
      }
    </style>
  </head>
  <body oncontextmenu="return false;">
    <canvas id="game"></canvas>
    <div id="info">Бросай снежки свайпом. Сбей все подарки.</div>
    <button id="restartBtn">Перезапуск</button>
    <div id="menuPopup" class="popup">
      <h2>Снежки</h2>
      <p>Сбей все подарки снежками!</p>
      <button id="startGameBtn">Начать игру</button>
      <a id="exit-button" href="https://maxim-prog292.github.io/select_game_NY/"
        >Назад</a
      >
    </div>
    <div id="resultPopup" class="popup"></div>
    <div id="gameUI">
      <div id="scoreDisplay">Счёт: 0</div>
      <div id="timeDisplay">Время: 60</div>
    </div>
    <img id="overlay1" src="images/top.png" />
    <img id="overlay2" src="images/bottom.png" />
    <img id="overlay3" src="images/left.png" />
    <img id="overlay4" src="images/right.png" />
    <script>
      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      canvas.width = 1920;
      canvas.height = 1080;

      let snowballs = [];
      let fragments = [];
      let targets = [];
      let score = 0;
      let timeLeft = 60;
      let gameOver = false;
      let showHitboxes = false;
      let slowMode = false;
      let timerInterval = null;
      let start = null;
      let gameActive = false;

      let R_TARGET = 40;
      let SPEED_TARGET = 3;
      let VAL_TARGET = 20;
      let START_TIME = 60;

      const endMessages = [
        "Ты как Данила Багров, только вместо обреза — снежок. Красиво работаешь!",
        "Твои снежки летят как метеориты, только без Челябинска!",
        "Снег летит, цели падают — это зима по ГОСТу!",
        "Если б это был баттл, ты бы взял первое место у Мороза!",
        "Вот это реакция! Даже в ТикТоке бы зашло в рекомендации!",
        "Снегурочка не успевают записывать твои рекорды — обнови ей Excel!",
        "Если б это был фильм, то назывался бы Форсаж: Снежный дрифт!",
        "Ты метаешь снежки так, будто прокачал ловкость до сотки!",
        "Раунд!",
        "Дв ты чо! ...",
        "Заслуженный метатель Российской Федерации!",
        "Зима уже оформила тебя в штат — без собеседования!",
        "После такой игры Мороз сказал: Ну всё, весну отменяем!",
        "Вот это поворот!",
        "Это база.",
        "Вотак вот, Вотак вот",
        "Умеете, могёте!",
      ];

      let targetImg = new Image();
      targetImg.src = "images/target.png";
      let snowballImg = new Image();
      snowballImg.src = "images/snowball.png";

      function spawnTarget() {
        return {
          x: Math.random() * (canvas.width - 100) + 50,
          y: Math.random() * 400 + 200,
          r: R_TARGET,
          dx:
            (Math.random() * SPEED_TARGET + 1) * (Math.random() < 0.5 ? -1 : 1),
          vy: 0,
          hit: false,
        };
      }

      function showMenu() {
        gameActive = false;
        gameOver = true;
        if (timerInterval) clearInterval(timerInterval);
        document.getElementById("menuPopup").style.display = "block";
        document.getElementById("resultPopup").style.display = "none";
        document.getElementById("gameUI").style.display = "none";
        document.getElementById("info").style.display = "none";
        document.getElementById("restartBtn").style.display = "none";

        snowballs = [];
        fragments = [];
      }

      function startGame() {
        score = 0;
        timeLeft = START_TIME;
        gameOver = false;
        gameActive = true;
        snowballs = [];
        fragments = [];
        targets = [];
        for (let i = 0; i < VAL_TARGET; i++) targets.push(spawnTarget());

        document.getElementById("menuPopup").style.display = "none";
        document.getElementById("resultPopup").style.display = "none";
        document.getElementById("gameUI").style.display = "flex";
        document.getElementById("info").style.display = "block";
        document.getElementById("restartBtn").style.display = "block";

        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          if (--timeLeft <= 0) endGame();
        }, 1000);

        updateUI();
      }

      function endGame() {
        gameOver = true;
        gameActive = false;
        clearInterval(timerInterval);
        document.getElementById("gameUI").style.display = "none";
        document.getElementById("info").style.display = "none";
        document.getElementById("restartBtn").style.display = "none";

        const msg = endMessages[Math.floor(Math.random() * endMessages.length)];
        const popup = document.getElementById("resultPopup");
        popup.style.display = "block";
        popup.innerHTML = `
        <h2>О как</h2>
        <p>Счёт: ${score}</p>
        <p>${msg}</p>
        <button id="restartGameBtn">Играть снова</button>
        <button id="backToMenuBtn">В меню</button>
      `;
        document
          .getElementById("restartGameBtn")
          .addEventListener("click", startGame);
        document
          .getElementById("backToMenuBtn")
          .addEventListener("click", showMenu);
      }

      // --- УПРАВЛЕНИЕ МЫШЬЮ ---
      canvas.addEventListener("mousedown", (e) => {
        if (!gameActive) return;
        start = { x: e.offsetX, y: e.offsetY };
      });

      canvas.addEventListener("mouseup", (e) => {
        if (!gameActive || !start) return;
        const dx = start.x - e.offsetX;
        const dy = start.y - e.offsetY;
        throwSnowball(start.x, start.y, dx, dy);
        start = null;
      });

      // --- УПРАВЛЕНИЕ ТАЧСКРИНОМ (МОБИЛЬНЫЕ) ---

      // Вспомогательная функция для перевода координат экрана в координаты канваса
      function getTouchPos(evt) {
        const rect = canvas.getBoundingClientRect();
        // Берем первый палец (changedTouches используется и для start, и для end)
        const touch = evt.changedTouches[0];
        const scaleX = canvas.width / rect.width; // Отношение реальной ширины к видимой
        const scaleY = canvas.height / rect.height; // Отношение реальной высоты к видимой

        return {
          x: (touch.clientX - rect.left) * scaleX,
          y: (touch.clientY - rect.top) * scaleY,
        };
      }

      canvas.addEventListener(
        "touchstart",
        (e) => {
          if (!gameActive) return;
          e.preventDefault(); // Блокируем скролл страницы
          start = getTouchPos(e);
        },
        { passive: false }
      );

      canvas.addEventListener(
        "touchend",
        (e) => {
          if (!gameActive || !start) return;
          e.preventDefault(); // Блокируем зум/скролл

          const endPos = getTouchPos(e);
          const dx = start.x - endPos.x;
          const dy = start.y - endPos.y;

          throwSnowball(start.x, start.y, dx, dy);
          start = null;
        },
        { passive: false }
      );

      // Общая функция броска (чтобы не дублировать код)
      function throwSnowball(x, y, dx, dy) {
        snowballs.push({
          x: x,
          y: y,
          vx: -dx / 10, // Сила броска (можно настроить делитель)
          vy: -dy / 10,
          r: 15,
        });
      }

      function createFragments(x, y) {
        const frags = [];
        for (let i = 0; i < 5; i++) {
          frags.push({
            x,
            y,
            vx: (Math.random() - 0.5) * 6,
            vy: (Math.random() - 1) * 6,
            r: 5,
          });
        }
        return frags;
      }

      function updateUI() {
        document.getElementById("scoreDisplay").textContent = `Счёт: ${score}`;
        document.getElementById(
          "timeDisplay"
        ).textContent = `Время: ${timeLeft}`;
      }

      function update() {
        if (!gameActive) return;

        for (const s of snowballs) {
          s.x += s.vx * (slowMode ? 0.5 : 1);
          s.y += s.vy * (slowMode ? 0.5 : 1);
          s.vy += 0.3;
        }
        snowballs = snowballs.filter((s) => s.y < canvas.height);

        for (const f of fragments) {
          f.x += f.vx;
          f.y += f.vy;
          f.vy += 0.3;
        }
        fragments = fragments.filter((f) => f.y < canvas.height);

        for (const t of targets) {
          if (!t.hit) {
            t.x += t.dx * (slowMode ? 0.5 : 1);
            if (t.x < t.r || t.x > canvas.width - t.r) t.dx *= -1;
          } else {
            t.vy += 0.3;
            t.y += t.vy;
          }
        }

        for (let i = snowballs.length - 1; i >= 0; i--) {
          const s = snowballs[i];
          for (const t of targets) {
            if (!t.hit && Math.hypot(s.x - t.x, s.y - t.y) < s.r + t.r) {
              t.hit = true;
              t.vy = 0;
              score += 10;

              fragments.push(...createFragments(s.x, s.y));
              snowballs.splice(i, 1);
              break;
            }
          }
        }

        if (targets.every((t) => t.hit && t.y - t.r > canvas.height)) endGame();

        updateUI();
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (gameActive || !gameOver) {
          for (const t of targets) {
            if (t.hit && t.y - t.r > canvas.height) continue;
            if (targetImg.complete) {
              ctx.drawImage(targetImg, t.x - t.r, t.y - t.r, t.r * 2, t.r * 2);
            } else {
              ctx.fillStyle = "#ff6666";
              ctx.beginPath();
              ctx.arc(t.x, t.y, t.r, 0, Math.PI * 2);
              ctx.fill();
            }
            if (showHitboxes)
              ctx.strokeRect(t.x - t.r, t.y - t.r, t.r * 2, t.r * 2);
          }

          for (const s of snowballs) {
            if (snowballImg.complete) {
              ctx.drawImage(
                snowballImg,
                s.x - s.r,
                s.y - s.r,
                s.r * 2,
                s.r * 2
              );
            } else {
              ctx.fillStyle = "#fff";
              ctx.beginPath();
              ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
              ctx.fill();
            }
          }
        }

        ctx.fillStyle = "#fff";
        for (const f of fragments) {
          ctx.beginPath();
          ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
      }
      loop();

      document.getElementById("restartBtn").onclick = startGame;
      document.getElementById("startGameBtn").onclick = startGame;

      window.addEventListener("keydown", (e) => {
        if (e.key === "r" || e.key === "R") {
          if (gameActive) startGame();
        }
        if (e.key === "h" || e.key === "H") showHitboxes = !showHitboxes;
        if (e.key === "s" || e.key === "S") slowMode = !slowMode;
      });

      showMenu();
    </script>

    <canvas id="snow"></canvas>
    <script src="snow.js"></script>
  </body>
</html>
